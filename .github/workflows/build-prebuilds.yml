name: Build Prebuilt Binaries

# Node.js Compatibility:
# - Built with Node.js 14 for optimal compatibility with Node.js 12.20.0+
# - Native addons built with Node.js 14 are compatible with Node.js 12-20
# - Using NAN for Native Addon abstraction layer

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.platform }}-node${{ matrix.node-version }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS builds
          - platform: darwin-arm64
            os: macos-latest
            arch: arm64
            go_os: darwin
            go_arch: arm64
            node-version: '14'
            
          - platform: darwin-x64
            os: macos-latest
            arch: x64
            go_os: darwin
            go_arch: amd64
            node-version: '14'
            
          # Linux builds
          - platform: linux-x64
            os: ubuntu-latest
            arch: x64
            go_os: linux
            go_arch: amd64
            node-version: '14'
            
          # Windows builds
          - platform: win32-x64
            os: windows-latest
            arch: x64
            go_os: windows
            go_arch: amd64
            node-version: '14'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: |
          node-client-v2/package-lock.json
          addon/package-lock.json

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        cache-dependency-path: 'cgo/go.sum'

    - name: Setup Python (for node-gyp)
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # 安装Python依赖，修复distutils问题
    - name: Install Python dependencies
      shell: bash
      run: |
        python -m pip install --upgrade pip
        python -m pip install setuptools wheel
        # 对于较新的Python版本，安装distutils
        python -c "import distutils" 2>/dev/null || python -m pip install setuptools-distutils || true

    # Windows specific setup - 使用现代方法
    - name: Setup Windows build environment
      if: runner.os == 'Windows'
      shell: bash
      run: |
        echo "Setting up Windows build environment..."
        # 确保使用正确的Python版本
        python --version
        # 获取Python路径
        PYTHON_PATH=$(which python)
        echo "Python path: $PYTHON_PATH"
        # 设置环境变量而不是npm config (npm v9+不再支持npm config set python)
        echo "npm_config_python=$PYTHON_PATH" >> $GITHUB_ENV
        echo "PYTHON=$PYTHON_PATH" >> $GITHUB_ENV
        echo "Windows build environment ready"

    - name: Install dependencies
      run: |
        echo "=== Installing Node.js dependencies ==="
        cd node-client-v2
        npm install
        echo "=== Installing Addon dependencies ==="
        cd ../addon
        npm install
        echo "=== Dependencies installed successfully ==="

    - name: Build Go shared library
      shell: bash
      env:
        GOOS: ${{ matrix.go_os }}
        GOARCH: ${{ matrix.go_arch }}
        CGO_ENABLED: 1
      run: |
        echo "=== Building Go shared library for ${{ matrix.platform }} ==="
        cd cgo
        
        # Initialize Go module and download dependencies
        echo "Initializing Go module..."
        go version
        go env
        
        echo "Current directory contents:"
        ls -la
        
        echo "Downloading Go dependencies..."
        go mod download
        go mod verify
        
        echo "Tidying Go modules..."
        go mod tidy
        
        mkdir -p ../node-client-v2/prebuilds/${{ matrix.platform }}
        
        # Set output file extension based on platform
        if [ "${{ matrix.go_os }}" = "windows" ]; then
          OUTPUT_FILE="../node-client-v2/prebuilds/${{ matrix.platform }}/librocketmq_cgo.dll"
        elif [ "${{ matrix.go_os }}" = "darwin" ]; then
          OUTPUT_FILE="../node-client-v2/prebuilds/${{ matrix.platform }}/librocketmq_cgo.dylib"
        else
          OUTPUT_FILE="../node-client-v2/prebuilds/${{ matrix.platform }}/librocketmq_cgo.so"
        fi
        
        echo "Building Go library: $OUTPUT_FILE"
        go build -v -buildmode=c-shared -o "$OUTPUT_FILE" rocketmq_cgo.go
        echo "Go library built successfully:"
        ls -la "$OUTPUT_FILE"
        file "$OUTPUT_FILE"

    - name: Build Node.js addon
      shell: bash
      env:
        npm_config_target_arch: ${{ matrix.arch }}
        npm_config_target_platform: ${{ matrix.go_os }}
        npm_config_cache: /tmp/.npm
        npm_config_build_from_source: true
        PYTHON: ${{ runner.os == 'Windows' && 'python' || 'python3' }}
      run: |
        echo "=== Building Node.js addon for ${{ matrix.platform }} ==="
        cd addon
        
        # 验证Python环境
        echo "Python version:"
        if [ "${{ runner.os }}" = "Windows" ]; then
          python --version
          echo "Checking distutils:"
          python -c "import distutils; print('distutils available')" || echo "distutils not available"
        else
          python3 --version
          echo "Checking distutils:"
          python3 -c "import distutils; print('distutils available')" || echo "distutils not available"
        fi
        
        echo "Building addon..."
        npm run build
        
        echo "Addon built successfully:"
        ls -la build/Release/
        file build/Release/rocketmq_addon.node
        
        # Copy to prebuilds directory
        mkdir -p ../node-client-v2/prebuilds/${{ matrix.platform }}
        cp build/Release/rocketmq_addon.node ../node-client-v2/prebuilds/${{ matrix.platform }}/
        echo "Copied to prebuilds:"
        ls -la ../node-client-v2/prebuilds/${{ matrix.platform }}/

    - name: Test binary loading
      if: matrix.platform == 'darwin-arm64' || matrix.platform == 'linux-x64' || matrix.platform == 'win32-x64'
      run: |
        cd node-client-v2
        npm run build
        node -e "
          const { getPlatformInfo, loadNativeAddon } = require('./dist/platform-loader');
          console.log('Platform:', getPlatformInfo());
          try {
            const addon = loadNativeAddon();
            console.log('✅ Successfully loaded addon');
          } catch (err) {
            console.error('❌ Failed to load addon:', err.message);
            process.exit(1);
          }
        "

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: prebuilds-${{ matrix.platform }}-node${{ matrix.node-version }}
        path: node-client-v2/prebuilds/${{ matrix.platform }}/
        retention-days: 30

  # Combine all prebuilds into a single artifact
  combine:
    name: Combine Prebuilds
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Combine prebuilds
      run: |
        mkdir -p node-client-v2/prebuilds
        
        # Copy all platform builds for Node.js 14
        for platform in darwin-arm64 darwin-x64 linux-x64 win32-x64; do
          if [ -d "artifacts/prebuilds-$platform-node14" ]; then
            mkdir -p "node-client-v2/prebuilds/$platform"
            cp -r "artifacts/prebuilds-$platform-node14/"* "node-client-v2/prebuilds/$platform/"
            echo "✅ Copied $platform prebuilds (Node.js 14)"
          else
            echo "⚠️  Missing $platform prebuilds (Node.js 14)"
          fi
        done
        
        # Show final structure
        find node-client-v2/prebuilds -type f -exec ls -la {} \;

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '14'

    - name: Build TypeScript SDK
      run: |
        cd node-client-v2
        npm install
        npm run build

    - name: Test all platforms
      run: |
        cd node-client-v2
        node scripts/build-all-platforms.js check

    - name: Upload combined prebuilds
      uses: actions/upload-artifact@v4
      with:
        name: rocketmq-native-sdk-prebuilds
        path: |
          node-client-v2/prebuilds/
          node-client-v2/dist/
          node-client-v2/package.json
          node-client-v2/README.md
        retention-days: 90

    - name: Create release assets (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        cd node-client-v2
        tar -czf ../rocketmq-native-sdk-${{ github.ref_name }}-prebuilds.tar.gz prebuilds/ dist/ package.json README.md
        
    - name: Upload release assets
      if: startsWith(github.ref, 'refs/tags/v')
      uses: actions/upload-artifact@v4
      with:
        name: release-assets
        path: rocketmq-native-sdk-*.tar.gz 