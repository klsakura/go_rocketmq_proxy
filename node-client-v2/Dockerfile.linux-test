FROM node:16-bullseye

# 安装Go
RUN wget https://go.dev/dl/go1.21.0.linux-amd64.tar.gz && \
    tar -C /usr/local -xzf go1.21.0.linux-amd64.tar.gz && \
    rm go1.21.0.linux-amd64.tar.gz

ENV PATH="/usr/local/go/bin:$PATH"

# 安装构建工具
RUN apt-get update && apt-get install -y build-essential python3

# 设置工作目录
WORKDIR /workspace

# 复制源代码
COPY . .

# 构建Go库
RUN cd cgo && \
    mkdir -p ../node-client-v2/prebuilds/linux-x64 && \
    GOOS=linux GOARCH=amd64 CGO_ENABLED=1 go build -buildmode=c-shared -o ../node-client-v2/prebuilds/linux-x64/librocketmq_cgo.so rocketmq_cgo.go

# 构建Node.js addon
RUN cd addon && \
    npm ci && \
    npm run build && \
    cp build/Release/rocketmq_addon.node ../node-client-v2/prebuilds/linux-x64/

# 验证构建结果
RUN ls -la node-client-v2/prebuilds/linux-x64/

CMD ["echo", "Build completed"] 